#include "matmul.h"
#include <math.h>
#include <stdio.h>
#include <stdlib.h>

#define CHECK(expr)                                                            \
    do {                                                                       \
        if (!(expr)) {                                                         \
            fprintf(stderr, "Test failed: " #expr "\n");                       \
            exit(1);                                                           \
        }                                                                      \
    } while (0)

int main(void) {
    enum { m = 5, n = 6, p = 7 };
    const alpaqa_real_t A[m * n] = {
        0.61113228, 0.9529772,  0.74924577, 0.51568769, 0.56001036, 0.84649711,
        0.08730924, 0.55334683, 0.94461341, 0.12905498, 0.8872747,  0.4941859,
        0.36385841, 0.69540253, 0.80592926, 0.17428937, 0.49070946, 0.25599133,
        0.45989209, 0.58529061, 0.3881149,  0.50261965, 0.31021319, 0.44043922,
        0.40273916, 0.5156209,  0.01383969, 0.50527367, 0.04140614, 0.7715414};
    const alpaqa_real_t B[n * p] = {
        0.74451101, 0.2944511,  0.81366652, 0.98518919, 0.36079859, 0.41290316,
        0.88843882, 0.07534795, 0.70478664, 0.89978689, 0.74953789, 0.29284082,
        0.34478576, 0.32527159, 0.60221849, 0.68297247, 0.9265756,  0.10758361,
        0.5018075,  0.12493132, 0.49383583, 0.88014813, 0.06604126, 0.05222306,
        0.14736193, 0.0063555,  0.03844403, 0.71443557, 0.15623901, 0.81767642,
        0.56179363, 0.50630585, 0.94479461, 0.60992415, 0.89080268, 0.51012277,
        0.74946269, 0.07286441, 0.68017635, 0.16994142, 0.50599256, 0.10172807};
    const alpaqa_real_t C_expected[] = {
        1.95083325, 1.80781341, 1.58956819, 1.85699068, 2.15119351, 1.83079978,
        2.02385537, 1.57461407, 1.77549823, 2.12971105, 1.5545094,  1.45692515,
        1.17406972, 1.63049044, 1.57631789, 1.05655216, 1.19897886, 0.89697792,
        1.15622512, 1.27716925, 0.73631622, 0.60041143, 0.77242236, 0.53996418,
        1.22627479, 2.32527606, 1.80057629, 1.73508134, 2.11895187, 2.25071401,
        1.40165897, 1.3958377,  1.10120853, 1.23353959, 1.35901997};
    alpaqa_real_t C[m * p];

    matmul(m, n, p, A, B, C);
    for (alpaqa_index_t i = 0; i < (alpaqa_length_t)m * p; ++i)
        CHECK(fabs((double)(C_expected[i] - C[i])) < 1e-7);

    const alpaqa_real_t x[m] = {0.28045429, 0.31165826, 0.92905151, 0.22333213,
                                0.19967747};
    const alpaqa_real_t b_expected[n] = {1.39147687, 1.015434,   1.05713196,
                                         0.65922102, 0.73248025, 0.78165337};
    alpaqa_real_t b[n];
    matvec_transp(m, n, A, x, b);
    for (alpaqa_index_t i = 0; i < (alpaqa_length_t)n; ++i)
        CHECK(fabs((double)(b_expected[i] - b[i])) < 1e-7);
    puts("Success.");
}
